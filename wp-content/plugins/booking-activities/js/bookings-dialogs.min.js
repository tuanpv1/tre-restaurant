$j(document).ready(function(){bookacti_init_bookings_dialogs();if($j(".bookacti-booking-action").length||$j(".bookacti-booking-group-action").length){bookacti_init_booking_actions()}if($j(".bookacti-bookings-bulk-action").length){bookacti_init_booking_bulk_actions();$j('.bookacti_export_button input[type="button"]').on("click",function(){var a=$j(this).closest(".bookacti_export_url").find(".bookacti_export_url_field input").val();if(a){window.open(a,"_blank")}})}});function bookacti_init_bookings_dialogs(){$j(".bookacti-bookings-dialog").dialog({modal:true,autoOpen:false,minHeight:300,minWidth:440,resize:"auto",show:true,hide:true,dialogClass:"bookacti-dialog",closeText:"&#10006;",close:function(){}});$j("body").on("click",".ui-widget-overlay",function(){$j("div:ui-dialog:visible").dialog("close")});$j(".bookacti-bookings-dialog").off("keydown").on("keydown",function(a){if(!$j("textarea").is(":focus")&&a.keyCode==$j.ui.keyCode.ENTER){$j(this).parent().find(".ui-dialog-buttonpane button:first").focus();return false}})}function bookacti_dialog_cancel_booking(a,b){b=b==="group"?"group":"single";var c=b==="group"?"bookactiCancelBookingGroup":"bookactiCancelBooking";$j("#bookacti-cancel-booking-dialog .bookacti-notices").remove();$j("#bookacti-cancel-booking-dialog").dialog("open");$j("#bookacti-cancel-booking-dialog").dialog("option","buttons",[{text:bookacti_localized.dialog_button_cancel_booking,"class":"bookacti-dialog-delete-button",click:function(){$j("#bookacti-cancel-booking-dialog .bookacti-notices").remove();var e,d;if(b==="single"){e=$j('.bookacti-cancel-booking[data-booking-id="'+a+'"]').parents("tr");d=$j('.bookacti-cancel-booking[data-booking-id="'+a+'"]').parents(".bookacti-booking-actions")}else{e=$j('.bookacti-cancel-booking-group[data-booking-group-id="'+a+'"]').parents("tr");d=$j('.bookacti-cancel-booking-group[data-booking-group-id="'+a+'"]').parents(".bookacti-booking-group-actions")}bookacti_booking_row_enter_loading_state(e);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:c,booking_id:a,nonce:bookacti_localized.nonce_cancel_booking},dataType:"json",success:function(g){if(g.status==="success"){$j("#bookacti-cancel-booking-dialog").dialog("close");d.html(g.new_actions_html);var i=e.find(".bookacti-booking-state").parent();e.find(".bookacti-booking-state").remove();i.append(g.formatted_state);if(g.allow_refund){bookacti_dialog_refund_booking(a,b)}$j("body").trigger("bookacti_booking_cancelled_by_user",[a,b])}else{if(g.status==="failed"){var h=typeof g.message!=="undefined"?g.message:"";if(!h){h+=bookacti_localized.error_cancel_booking;var f=typeof g.error!=="undefined"?g.error:"";if(f){h+=" ("+f+")"}}$j("#bookacti-cancel-booking-dialog").append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>'+h+"</li></ul></div>");console.log(h);console.log(g)}}},error:function(f){$j("#bookacti-cancel-booking-dialog").append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error_cancel_booking+"</li></ul></div>");console.log("AJAX "+bookacti_localized.error_cancel_booking);console.log(f)},complete:function(){$j("#bookacti-cancel-booking-dialog .bookacti-notices").show();bookacti_booking_row_exit_loading_state(e)}})}},{text:bookacti_localized.dialog_button_cancel,click:function(){$j(this).dialog("close")}}])}function bookacti_dialog_refund_booking(a,c){c=c==="group"?"group":"single";var d=c==="group"?"bookactiGetBookingGroupRefundActionsHTML":"bookactiGetBookingRefundActionsHTML";var b=c==="group"?"bookactiRefundBookingGroup":"bookactiRefundBooking";$j("#bookacti-refund-booking-dialog").empty();$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:d,booking_id:a,nonce:bookacti_localized.nonce_get_refund_actions_html},dataType:"json",success:function(f){if(f.status==="success"){var j=[];$j("#bookacti-refund-booking-dialog").html(f.actions_html);if(!$j.isEmptyObject(f.actions_array)){$j('#bookacti-refund-options input[type="radio"]:first').prop("checked",true);var g=$j("<div />",{id:"bookacti-refund-message"});var i=$j("<strong />",{text:bookacti_localized.ask_for_reasons});var k=$j("<textarea />",{name:"refund-message"});g.append(i);g.append(k);$j("#bookacti-refund-options").append(g);j.push({text:bookacti_localized.dialog_button_refund,"class":"bookacti-dialog-delete-button",click:function(){$j("#bookacti-refund-booking-dialog .bookacti-notices").remove();var s,m;if(c==="single"){s=$j('.bookacti-refund-booking[data-booking-id="'+a+'"]').parents("tr");m=$j('.bookacti-refund-booking[data-booking-id="'+a+'"]').parents(".bookacti-booking-actions")}else{s=$j('.bookacti-refund-booking-group[data-booking-group-id="'+a+'"]').parents("tr");m=$j('.bookacti-refund-booking-group[data-booking-group-id="'+a+'"]').parents(".bookacti-booking-group-actions")}var q=s.parents("#bookacti-bookings-list").length?1:0;var l=0;if(q){m=s.find("td.actions.column-actions");l=s.next().hasClass("bookacti-gouped-booking")?1:0}var p='<div class="bookacti-loading-alt"><img class="bookacti-loader" src="'+bookacti_localized.plugin_path+'/img/ajax-loader.gif" title="'+bookacti_localized.loading+'" /><span class="bookacti-loading-alt-text" >'+bookacti_localized.loading+"</span></div>";s.find(".bookacti-booking-state").hide();s.find(".bookacti-booking-state").after(p);var r=$j('#bookacti-refund-options input[name="refund-action"]:checked').val();var o=$j('#bookacti-refund-message textarea[name="refund-message"]').val();var n=$j("#bookacti-refund-options #nonce_refund_booking").val();$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:b,booking_id:a,refund_action:r,refund_message:o,is_admin:bookacti_localized.is_admin,reload_grouped_bookings:l,nonce:n},dataType:"json",success:function(v){if(v.status==="success"){var x={message:"",new_status:bookacti_localized.refunded};if(r==="email"){x.message+=bookacti_localized.advice_refund_request_email_sent;x.new_status=bookacti_localized.refund_requested}m.html(v.new_actions_html);var y=s.find(".bookacti-booking-state").parent();s.find(".bookacti-booking-state").remove();y.append(v.formatted_state);if(l&&typeof v.grouped_booking_rows!=="undefined"){var u=s.next().hasClass("hidden");s.nextUntil("tr:not(.bookacti-gouped-booking)").remove();s.after(v.grouped_booking_rows);if(u){s.nextUntil("tr:not(.bookacti-gouped-booking)").addClass("hidden");if(s.nextUntil("tr:not(.bookacti-gouped-booking)").length%2){s.after('<tr class="bookacti-gouped-booking hidden dummy"></tr>')}}}$j("body").trigger("bookacti_booking_refunded",[a,c,r,o,x,v]);bookacti_dialog_refund_confirmation(x.message)}else{if(v.status==="failed"){var w=typeof v.message!=="undefined"?v.message:"";if(!w){w+=bookacti_localized.error_refund_booking;var t=typeof v.error!=="undefined"?v.error:"";if(t){w+=" ("+t+")"}}$j("#bookacti-refund-booking-dialog").append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>'+w+"</li></ul></div>");console.log(w);console.log(v)}}},error:function(t){console.log("AJAX "+bookacti_localized.error_refund_booking);console.log(t)},complete:function(){$j("#bookacti-refund-booking-dialog .bookacti-notices").show();s.find(".bookacti-loading-alt").remove();s.find(".bookacti-booking-state").show()}});$j(this).dialog("close")}})}j.push({text:bookacti_localized.dialog_button_cancel,click:function(){$j(this).dialog("close")}});$j("#bookacti-refund-booking-dialog").dialog("option","buttons",j)}else{if(f.status==="failed"){var h=typeof f.message!=="undefined"?f.message:"";if(!h){h+=bookacti_localized.error_refund_booking;var e=typeof f.error!=="undefined"?f.error:"";if(e){h+=" ("+e+")"}}$j("#bookacti-refund-booking-dialog").append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>'+h+"</li></ul></div>");console.log(h);console.log(f)}}$j("#bookacti-refund-booking-dialog").dialog("open")},error:function(f){console.log("AJAX "+bookacti_localized.error_refund_booking);console.log(f)},complete:function(){$j("#bookacti-refund-booking-dialog .bookacti-notices").show()}})}function bookacti_dialog_refund_confirmation(a){$j("#bookacti-refund-booking-confirm-dialog").html(a);$j("#bookacti-refund-booking-confirm-dialog").dialog("open");$j("#bookacti-refund-booking-confirm-dialog").dialog("option","buttons",[{text:bookacti_localized.dialog_button_ok,click:function(){$j(this).dialog("close")}}])}function bookacti_dialog_change_booking_state(i,c){c=c==="group"?"group":"single";var b=c==="group"?"bookactiChangeBookingGroupState":"bookactiChangeBookingState";var h,a;if(c==="single"){h=$j('.bookacti-change-booking-state[data-booking-id="'+i+'"]').parents("tr");a=$j('.bookacti-change-booking-state[data-booking-id="'+i+'"]').parents(".bookacti-booking-actions")}else{h=$j('.bookacti-change-booking-group-state[data-booking-group-id="'+i+'"]').parents("tr");a=$j('.bookacti-change-booking-group-state[data-booking-group-id="'+i+'"]').parents(".bookacti-booking-group-actions")}var g=h.parents("#bookacti-bookings-list").length?1:0;var f=0;if(g){a=h.find("td.actions.column-actions");f=h.next().hasClass("bookacti-gouped-booking")?1:0}var d=h.find(".bookacti-booking-state").data("booking-state");var e=h.find(".bookacti-payment-status").data("payment-status");if(d){$j('#bookacti-select-booking-state option[value="'+d+'"]').prop("selected",true)}if(e){$j('#bookacti-select-payment-status option[value="'+e+'"]').prop("selected",true)}$j("#bookacti-send-notifications-on-state-change").prop("checked",false);$j("#bookacti-change-booking-state-dialog .bookacti-notices").remove();$j("#bookacti-change-booking-state-dialog").dialog("option","buttons",[{text:bookacti_localized.dialog_button_ok,click:function(){var k=$j("select#bookacti-select-booking-state").val();var m=$j("select#bookacti-select-payment-status").val();var j=$j("#bookacti-send-notifications-on-state-change").prop("checked")?1:0;var l=$j("#bookacti-change-booking-state-dialog #nonce_change_booking_state").val();if((k||m)&&(k!==d||m!==e)){$j("#bookacti-change-booking-state-dialog .bookacti-notices").remove();bookacti_booking_row_enter_loading_state(h);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:b,booking_id:i,new_booking_state:d!==k?k:0,new_payment_status:m,send_notifications:j,is_bookings_page:g,reload_grouped_bookings:f,nonce:l},dataType:"json",success:function(p){if(p.status==="success"){$j("#bookacti-change-booking-state-dialog").dialog("close");if(f&&typeof p.grouped_booking_rows!=="undefined"){var o=h.next().hasClass("hidden");h.nextUntil("tr:not(.bookacti-gouped-booking)").remove();h.after(p.grouped_booking_rows);if(o){h.nextUntil("tr:not(.bookacti-gouped-booking)").addClass("hidden");if(h.nextUntil("tr:not(.bookacti-gouped-booking)").length%2){h.after('<tr class="bookacti-gouped-booking hidden dummy"></tr>')}}}h.replaceWith(p.row);bookacti_refresh_list_table_hidden_columns();if(d!==k){$j("body").trigger("bookacti_booking_state_changed",[i,c,k,d,g,p.active_changed])}if(e!==m){$j("body").trigger("bookacti_payment_status_changed",[i,c,m,e])}}else{if(p.status==="failed"){var q=typeof p.message!=="undefined"?p.message:"";if(!q){q+=bookacti_localized.error_change_booking_state;var n=typeof p.error!=="undefined"?p.error:"";if(n){q+=" ("+n+")"}}$j("#bookacti-change-booking-state-dialog").append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>'+q+"</li></ul></div>").show();console.log(q);console.log(p)}}},error:function(n){$j("#bookacti-change-booking-state-dialog").append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error_change_booking_state+"</li></ul></div>").show();console.log("AJAX "+bookacti_localized.error_change_booking_state);console.log(n)},complete:function(){$j("#bookacti-change-booking-state-dialog .bookacti-notices").show();bookacti_booking_row_exit_loading_state(h)}})}}},{text:bookacti_localized.dialog_button_cancel,click:function(){$j(this).dialog("close")}}]);$j("#bookacti-change-booking-state-dialog").dialog("open")}function bookacti_dialog_reschedule_booking(a){var e=$j('.bookacti-booking-action[data-booking-id="'+a+'"]').parents("tr");var b=$j("#bookacti-booking-system-reschedule.bookacti-booking-system");var c=0;var d=bookacti_localized.is_admin?1:0;if(d){$j("#bookacti-send-notifications-on-reschedule").prop("checked",false)}bookacti_booking_row_enter_loading_state(e);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiGetBookingData",booking_id:a,nonce:bookacti_localized.nonce_get_booking_data},dataType:"json",success:function(g){if(g.status==="success"){bookacti_clear_booking_system_displayed_info(b);var f=b.attr("id");var i=g.booking_data.activity_id;c=g.booking_data.quantity;$j.each(bookacti.booking_system[f],function(j,k){if(!g.booking_data.form_calendar_settings.hasOwnProperty(j)){return true}if($j.inArray(j,["auto_load","class","id","method"])>=0){return true}bookacti.booking_system[f][j]=g.booking_data.form_calendar_settings[j]});bookacti.booking_system[f]["activities"]=i?[i]:[0];if(d){bookacti.booking_system[f]["calendars"]=[];bookacti.booking_system[f]["groups_single_events"]=1;bookacti.booking_system[f]["past_events"]=1;bookacti.booking_system[f]["past_events_bookable"]=1;bookacti.booking_system[f]["template_data"]=[]}b.trigger("bookacti_before_reschedule_booking_system_loads",[g.booking_data]);bookacti_reload_booking_system(b);$j("#bookacti-reschedule-booking-dialog").dialog("open")}else{if(g.status==="failed"){var h=bookacti_localized.error_retrieve_booking_system;if(g.error==="not_allowed"){h+="\n"+bookacti_localized.error_not_allowed}console.log(h);console.log(g)}}},error:function(f){console.log("AJAX "+bookacti_localized.error_retrieve_booking_system);console.log(f)},complete:function(){bookacti_booking_row_exit_loading_state(e)}});$j("#bookacti-reschedule-booking-dialog").dialog("option","buttons",[{text:bookacti_localized.dialog_button_reschedule,"class":"bookacti-dialog-delete-button",click:function(){var i=b.parent().find('input[name="bookacti_event_id"]').val();var h=b.parent().find('input[name="bookacti_event_start"]').val();var g=b.parent().find('input[name="bookacti_event_end"]').val();var j=bookacti_validate_picked_events(b,c);if(j){var f=1;if(d&&$j("#bookacti-send-notifications-on-reschedule").length){f=$j("#bookacti-send-notifications-on-reschedule").prop("checked")?1:0}bookacti_booking_row_enter_loading_state(e);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:{action:"bookactiRescheduleBooking",booking_id:a,event_id:i,event_start:h,event_end:g,is_bookings_page:d,send_notifications:f,nonce:bookacti_localized.nonce_reschedule_booking},dataType:"json",success:function(l){if(l.status==="success"){$j("#bookacti-reschedule-booking-dialog").dialog("close");if(e.parents("#bookacti-bookings-list, .bookacti-user-bookings-list").length>0){e.after(l.row);e.remove();bookacti_refresh_list_table_hidden_columns()}$j("body").trigger("bookacti_booking_rescheduled",[a,h,g,l])}else{var m=typeof l.message!=="undefined"?l.message:"";if(!m){m+=bookacti_localized.error_reschedule_booking;var k=typeof l.error!=="undefined"?l.error:"";if(k){m+=" ("+k+")"}}b.siblings(".bookacti-notices").html("<ul class='bookacti-error-list'><li>"+m+"</li></ul>").show();console.log(bookacti_localized.error_reschedule_booking);console.log(l)}},error:function(k){console.log("AJAX "+bookacti_localized.error_reschedule_booking);console.log(k)},complete:function(){bookacti_booking_row_exit_loading_state(e)}})}}},{text:bookacti_localized.dialog_button_cancel,click:function(){$j(this).dialog("close")}}])}function bookacti_dialog_delete_booking(a,b){b=b==="group"?"group":"single";var d,c;if(b==="single"){c="bookactiDeleteBooking";d=$j('.bookacti-delete-booking[data-booking-id="'+a+'"]').parents("tr");$j(".bookacti-delete-booking-group-description").hide()}else{c="bookactiDeleteBookingGroup";d=$j('.bookacti-delete-booking-group[data-booking-group-id="'+a+'"]').parents("tr");$j(".bookacti-delete-booking-group-description").show()}$j('#bookacti-delete-booking-dialog input[name="action"]').val(c);$j('#bookacti-delete-booking-dialog input[name="booking_id"]').val(a);$j('#bookacti-delete-booking-dialog input[name="booking_type"]').val(b);$j("#bookacti-delete-booking-dialog .bookacti-notices").remove();$j("#bookacti-delete-booking-dialog").dialog("option","buttons",[{text:bookacti_localized.dialog_button_delete,"class":"bookacti-dialog-delete-button",click:function(){$j("#bookacti-delete-booking-dialog .bookacti-notices").remove();var e=$j("#bookacti-delete-booking-dialog form").serialize();bookacti_booking_row_enter_loading_state(d);var f='<div class="bookacti-loading-alt"><img class="bookacti-loader" src="'+bookacti_localized.plugin_path+'/img/ajax-loader.gif" title="'+bookacti_localized.loading+'" /><span class="bookacti-loading-alt-text" >'+bookacti_localized.loading+"</span></div>";$j("#bookacti-delete-booking-dialog").append(f);$j.ajax({url:bookacti_localized.ajaxurl,type:"POST",data:e,dataType:"json",success:function(h){if(h.status==="success"){$j("#bookacti-delete-booking-dialog").dialog("close");if(b==="group"&&$j(".bookacti-booking-group-id-"+a).length){var i=$j(".bookacti-booking-group-id-"+a);i.removeClass("bookacti-gouped-booking").animate({opacity:0},function(){i.children("td, th").animate({padding:0}).wrapInner("<div />").children().slideUp(function(){i.remove()})})}d.animate({opacity:0},function(){d.children("td, th").animate({padding:0}).wrapInner("<div />").children().slideUp(function(){d.remove()})})}else{if(h.status==="failed"){var j=typeof h.message!=="undefined"?h.message:"";if(!j){j+=bookacti_localized.error_delete_booking;var g=typeof h.error!=="undefined"?h.error:"";if(g){j+=" ("+g+")"}}$j("#bookacti-delete-booking-dialog").append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>'+j+"</li></ul></div>");console.log(j);console.log(h)}}},error:function(g){$j("#bookacti-delete-booking-dialog").append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error_delete_booking+"</li></ul></div>");console.log("AJAX "+bookacti_localized.error_delete_booking);console.log(g)},complete:function(){$j("#bookacti-delete-booking-dialog .bookacti-notices").show();$j("#bookacti-delete-booking-dialog .bookacti-loading-alt").remove();bookacti_booking_row_exit_loading_state(d)}})}},{text:bookacti_localized.dialog_button_cancel,"class":"bookacti-dialog-left-button",click:function(){$j(this).dialog("close")}}]);$j("#bookacti-delete-booking-dialog").dialog("open")}function bookacti_dialog_export_bookings(){$j("#bookacti_export_bookings_url_secret").val("");$j("#bookacti-export-bookings-url-container").hide();$j("#bookacti-export-bookings-dialog .bookacti-notices").remove();$j("#bookacti-export-bookings-dialog").dialog("option","buttons",[{text:bookacti_localized.dialog_button_ok,click:function(){bookacti_generate_export_bookings_url(false)}},{text:bookacti_localized.dialog_button_reset,"class":"bookacti-dialog-delete-button bookacti-dialog-left-button",click:function(){bookacti_generate_export_bookings_url(true)}}]);$j("#bookacti-export-bookings-dialog").dialog("open")}function bookacti_generate_export_bookings_url(b){b=b||false;$j("#bookacti-export-bookings-dialog .bookacti-notices").remove();var c='<div class="bookacti-loading-alt"><img class="bookacti-loader" src="'+bookacti_localized.plugin_path+'/img/ajax-loader.gif" title="'+bookacti_localized.loading+'" /><span class="bookacti-loading-alt-text" >'+bookacti_localized.loading+"</span></div>";$j("#bookacti-export-bookings-dialog").append(c);$j("#bookacti-export-bookings-dialog select[multiple].bookacti-items-select-box option").prop("selected",true);var a=$j("#bookacti-export-bookings-form").serializeObject();a.action="bookactiExportBookingsUrl";a.reset_key=b?1:0;a.booking_filters=$j("#bookacti-booking-list-filters-form").serializeObject();$j.ajax({url:ajaxurl,type:"POST",data:a,dataType:"json",success:function(e){if(e.status==="success"){$j("#bookacti_export_bookings_url_secret").val(e.url);$j("#bookacti-export-bookings-dialog").append('<div class="bookacti-notices"><ul class="bookacti-success-list"><li>'+e.message+"</li></ul></div>").show();$j("#bookacti-export-bookings-url-container").show();$j("#bookacti-form-editor").trigger("bookacti_export_bookings_url",[e])}else{if(e.status==="failed"){var f=typeof e.message!=="undefined"?e.message:"";if(!f){f+=bookacti_localized.error_reset_export_bookings_url;var d=typeof e.error!=="undefined"?e.error:"";if(d){f+=" ("+d+")"}}$j("#bookacti-export-bookings-dialog").append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>'+f+"</li></ul></div>").show();console.log(f);console.log(e)}}},error:function(d){$j("#bookacti-export-bookings-dialog").append('<div class="bookacti-notices"><ul class="bookacti-error-list"><li>AJAX '+bookacti_localized.error_reset_export_bookings_url+"</li></ul></div>").show();console.log("AJAX "+bookacti_localized.error_reset_export_bookings_url);console.log(d)},complete:function(){$j("#bookacti-export-bookings-dialog .bookacti-notices").show();$j("#bookacti-export-bookings-dialog .bookacti-loading-alt").remove()}})};